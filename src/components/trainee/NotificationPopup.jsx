import React, { useEffect, useState } from "react";
import "./header.css"
import { getTraineeNotifications } from "../../services/trainee/trainee";
import { DateTime } from "luxon";

// Icons 
const SystemIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M22.7792 10.3425L21.0058 8.56917C20.7025 8.26583 20.4575 7.67083 20.4575 7.25083V4.73083C20.4575 3.70417 19.6175 2.86417 18.5908 2.86417H16.0825C15.6625 2.86417 15.0675 2.61917 14.7642 2.31583L12.9908 0.5425C12.2675 -0.180833 11.0775 -0.180833 10.3542 0.5425L8.5575 2.31583C8.26583 2.61917 7.67083 2.86417 7.23917 2.86417H4.73083C3.70417 2.86417 2.86417 3.70417 2.86417 4.73083V7.23917C2.86417 7.65917 2.61917 8.25417 2.31583 8.5575L0.5425 10.3308C-0.180833 11.0542 -0.180833 12.2442 0.5425 12.9675L2.31583 14.7408C2.61917 15.0442 2.86417 15.6392 2.86417 16.0592V18.5675C2.86417 19.5942 3.70417 20.4342 4.73083 20.4342H7.23917C7.65917 20.4342 8.25417 20.6792 8.5575 20.9825L10.3308 22.7558C11.0542 23.4792 12.2442 23.4792 12.9675 22.7558L14.7408 20.9825C15.0442 20.6792 15.6392 20.4342 16.0592 20.4342H18.5675C19.5942 20.4342 20.4342 19.5942 20.4342 18.5675V16.0592C20.4342 15.6392 20.6792 15.0442 20.9825 14.7408L22.7558 12.9675C23.5142 12.2558 23.5142 11.0658 22.7792 10.3425ZM6.99417 8.16083C6.99417 7.51917 7.51917 6.99417 8.16083 6.99417C8.8025 6.99417 9.3275 7.51917 9.3275 8.16083C9.3275 8.8025 8.81417 9.3275 8.16083 9.3275C7.51917 9.3275 6.99417 8.8025 6.99417 8.16083ZM8.77917 15.7792C8.60417 15.9542 8.3825 16.0358 8.16083 16.0358C7.93917 16.0358 7.7175 15.9542 7.5425 15.7792C7.20417 15.4408 7.20417 14.8808 7.5425 14.5425L14.5425 7.5425C14.8808 7.20417 15.4408 7.20417 15.7792 7.5425C16.1175 7.88083 16.1175 8.44083 15.7792 8.77917L8.77917 15.7792ZM15.1608 16.3275C14.5075 16.3275 13.9825 15.8025 13.9825 15.1608C13.9825 14.5192 14.5075 13.9942 15.1492 13.9942C15.7908 13.9942 16.3158 14.5192 16.3158 15.1608C16.3158 15.8025 15.8025 16.3275 15.1608 16.3275Z" fill="#775DA6" />
    </svg>
);

const ExpertIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" fill="none">
        <path d="M22.7501 8.75001L21.0117 10.4883L17.5117 6.98834L19.2501 5.25001C19.7401 4.76001 20.3701 4.52667 21.0001 4.52667C21.6301 4.52667 22.2601 4.76001 22.7501 5.25001C23.7184 6.21834 23.7184 7.78167 22.7501 8.75001Z" fill="#775DA6" />
        <path d="M20.1953 11.3167L7.58367 23.9167C6.61534 24.885 5.05201 24.885 4.08367 23.9167C3.11534 22.9483 3.11534 21.385 4.08367 20.4167L16.6953 7.81668L20.1953 11.3167Z" fill="#775DA6" />
        <path d="M11.6083 4.08332L12.0866 2.46166C12.1333 2.30999 12.0866 2.14666 11.9816 2.02999C11.8766 1.91332 11.6899 1.86666 11.5383 1.91332L9.9166 2.39166L8.29494 1.91332C8.14327 1.86666 7.97994 1.91332 7.86327 2.01832C7.7466 2.13499 7.71161 2.29832 7.75827 2.44999L8.22494 4.08332L7.7466 5.70499C7.69994 5.85666 7.74661 6.01999 7.85161 6.13666C7.96827 6.25332 8.13161 6.28832 8.28327 6.24166L9.9166 5.77499L11.5383 6.25332C11.5849 6.26499 11.6199 6.27666 11.6666 6.27666C11.7833 6.27666 11.8883 6.22999 11.9816 6.14832C12.0983 6.03166 12.1333 5.86832 12.0866 5.71666L11.6083 4.08332Z" fill="#775DA6" />
        <path d="M6.94128 11.0833L7.41961 9.46166C7.46628 9.30999 7.41961 9.14666 7.31461 9.02999C7.19795 8.91332 7.03461 8.87832 6.88295 8.92499L5.24961 9.39166L3.62795 8.91332C3.47628 8.86666 3.31295 8.91332 3.19628 9.01832C3.07961 9.13499 3.04461 9.29832 3.09128 9.44999L3.55795 11.0833L3.07961 12.705C3.03295 12.8567 3.07961 13.02 3.18461 13.1367C3.30128 13.2533 3.46461 13.2883 3.61628 13.2417L5.23795 12.7633L6.85961 13.2417C6.89461 13.2533 6.94128 13.2533 6.98795 13.2533C7.10461 13.2533 7.20961 13.2067 7.30295 13.125C7.41961 13.0083 7.45461 12.845 7.40795 12.6933L6.94128 11.0833Z" fill="#775DA6" />
        <path d="M24.4413 16.9167L24.9197 15.295C24.9663 15.1433 24.9197 14.98 24.8147 14.8633C24.698 14.7467 24.5347 14.7117 24.383 14.7583L22.7613 15.2367L21.1397 14.7583C20.988 14.7117 20.8247 14.7583 20.708 14.8633C20.5913 14.98 20.5563 15.1433 20.603 15.295L21.0813 16.9167L20.603 18.5383C20.5563 18.69 20.603 18.8533 20.708 18.97C20.8247 19.0867 20.988 19.1217 21.1397 19.075L22.7613 18.5967L24.383 19.075C24.418 19.0867 24.4647 19.0867 24.5113 19.0867C24.628 19.0867 24.733 19.04 24.8263 18.9583C24.943 18.8417 24.978 18.6783 24.9313 18.5267L24.4413 16.9167Z" fill="#775DA6" />
    </svg>
);

const AdminIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" fill="none">
        <path d="M22.7501 8.75001L21.0117 10.4883L17.5117 6.98834L19.2501 5.25001C19.7401 4.76001 20.3701 4.52667 21.0001 4.52667C21.6301 4.52667 22.2601 4.76001 22.7501 5.25001C23.7184 6.21834 23.7184 7.78167 22.7501 8.75001Z" fill="#B60123" />
        <path d="M20.1953 11.3167L7.58367 23.9167C6.61534 24.885 5.05201 24.885 4.08367 23.9167C3.11534 22.9483 3.11534 21.385 4.08367 20.4167L16.6953 7.81668L20.1953 11.3167Z" fill="#B60123" />
        <path d="M11.6083 4.08332L12.0866 2.46166C12.1333 2.30999 12.0866 2.14666 11.9816 2.02999C11.8766 1.91332 11.6899 1.86666 11.5383 1.91332L9.9166 2.39166L8.29494 1.91332C8.14327 1.86666 7.97994 1.91332 7.86327 2.01832C7.7466 2.13499 7.71161 2.29832 7.75827 2.44999L8.22494 4.08332L7.7466 5.70499C7.69994 5.85666 7.74661 6.01999 7.85161 6.13666C7.96827 6.25332 8.13161 6.28832 8.28327 6.24166L9.9166 5.77499L11.5383 6.25332C11.5849 6.26499 11.6199 6.27666 11.6666 6.27666C11.7833 6.27666 11.8883 6.22999 11.9816 6.14832C12.0983 6.03166 12.1333 5.86832 12.0866 5.71666L11.6083 4.08332Z" fill="#B60123" />
        <path d="M6.94128 11.0833L7.41961 9.46166C7.46628 9.30999 7.41961 9.14666 7.31461 9.02999C7.19795 8.91332 7.03461 8.87832 6.88295 8.92499L5.24961 9.39166L3.62795 8.91332C3.47628 8.86666 3.31295 8.91332 3.19628 9.01832C3.07961 9.13499 3.04461 9.29832 3.09128 9.44999L3.55795 11.0833L3.07961 12.705C3.03295 12.8567 3.07961 13.02 3.18461 13.1367C3.30128 13.2533 3.46461 13.2883 3.61628 13.2417L5.23795 12.7633L6.85961 13.2417C6.89461 13.2533 6.94128 13.2533 6.98795 13.2533C7.10461 13.2533 7.20961 13.2067 7.30295 13.125C7.41961 13.0083 7.45461 12.845 7.40795 12.6933L6.94128 11.0833Z" fill="#B60123" />
        <path d="M24.4413 16.9167L24.9197 15.295C24.9663 15.1433 24.9197 14.98 24.8147 14.8633C24.698 14.7467 24.5347 14.7117 24.383 14.7583L22.7613 15.2367L21.1397 14.7583C20.988 14.7117 20.8247 14.7583 20.708 14.8633C20.5913 14.98 20.5563 15.1433 20.603 15.295L21.0813 16.9167L20.603 18.5383C20.5563 18.69 20.603 18.8533 20.708 18.97C20.8247 19.0867 20.988 19.1217 21.1397 19.075L22.7613 18.5967L24.383 19.075C24.418 19.0867 24.4647 19.0867 24.5113 19.0867C24.628 19.0867 24.733 19.04 24.8263 18.9583C24.943 18.8417 24.978 18.6783 24.9313 18.5267L24.4413 16.9167Z" fill="#B60123" />
    </svg>
)

export default function NotificationPopup({ open, onClose }) {
    const [notifications, setNotifications] = useState([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (open) {
            fetchNotifications();
        }
    }, [open]);

    const fetchNotifications = async () => {
        try {
            setLoading(true);
            const response = await getTraineeNotifications();
            if (response && response.success) {
                setNotifications(response.data.notifications || []);
            }
        } catch (error) {
            console.error("Failed to fetch notifications", error);
        } finally {
            setLoading(false);
        }
    };

    const handleOverlayClick = (e) => {
        if (e.target === e.currentTarget) {
            onClose && onClose()
        }
    }

    const formatTitle = (type) => {
        if (!type) return "Notification";
        return type
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    };

    const getIcon = (userType) => {
        switch (userType?.toLowerCase()) {
            case 'expert':
                return <ExpertIcon />;
            case 'admin':
                return <AdminIcon />;
            case 'system':
            default:
                return <SystemIcon />;
        }
    };

    const groupedNotifications = notifications.reduce((acc, note) => {
        const dt = DateTime.fromISO(note.createdAt);
        const today = DateTime.now().startOf('day');
        const yesterday = DateTime.now().minus({ days: 1 }).startOf('day');
        const noteDate = dt.startOf('day');

        let key = dt.toFormat('dd MMM yyyy');
        if (noteDate.hasSame(today, 'day')) {
            key = 'Today';
        } else if (noteDate.hasSame(yesterday, 'day')) {
            key = 'Yesterday';
        }

        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(note);
        return acc;
    }, {});

    if (!open) return null

    return (
        <div className="profile-popup-overlay" onClick={handleOverlayClick}>
            <div className="notification-popup-card">
                <div className="notification-list">
                    {loading ? (
                        <div style={{ padding: '20px', textAlign: 'center', color: '#666' }}>Loading notifications...</div>
                    ) : notifications.length === 0 ? (
                        <div style={{ padding: '20px', textAlign: 'center', color: '#666' }}>No new notifications</div>
                    ) : (
                        Object.entries(groupedNotifications).map(([dateLabel, notes]) => (
                            <div key={dateLabel} className="notification-date-group">
                                <div className="notification-date-label">{dateLabel}</div>
                                {notes.map((note) => (
                                    <div key={note.createdAt} className="notification-item">
                                        <div className="notification-icon-box">
                                            {getIcon(note.sender?.userType)}
                                        </div>
                                        <div className="notification-content">
                                            <span className="notification-title">{formatTitle(note.type)}</span>
                                            <span className="notification-subtext">{note.data?.message}</span>
                                        </div>
                                        {/* Delete button (functionality not implemented yet, using placeholder) */}
                                        {/* <button type="button" className="notification-delete-btn">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                         <path d="M21.0697 5.23C19.4597 5.07 17.8497 4.95 16.2297 4.86V4.85L16.0097 3.55C15.8597 2.63 15.6397 1.25 13.2997 1.25H10.6797C8.34967 1.25 8.12967 2.57 7.96967 3.54L7.75967 4.82C6.82967 4.88 5.89967 4.94 4.96967 5.03L2.92967 5.23C2.50967 5.27 2.20967 5.64 2.24967 6.05C2.28967 6.46 2.64967 6.76 3.06967 6.72L5.10967 6.52C10.3497 6 15.6297 6.2 20.9297 6.73C20.9597 6.73 20.9797 6.73 21.0097 6.73C21.3897 6.73 21.7197 6.44 21.7597 6.05C21.7897 5.64 21.4897 5.27 21.0697 5.23Z" fill="#B60123"/>
                         <path d="M19.2297 8.14C18.9897 7.89 18.6597 7.75 18.3197 7.75H5.67975C5.33975 7.75 4.99975 7.89 4.76975 8.14C4.53975 8.39 4.40975 8.73 4.42975 9.08L5.04975 19.34C5.15975 20.86 5.29975 22.76 8.78975 22.76H15.2097C18.6997 22.76 18.8398 20.87 18.9497 19.34L19.5697 9.09C19.5897 8.73 19.4597 8.39 19.2297 8.14ZM13.6597 17.75H10.3297C9.91975 17.75 9.57975 17.41 9.57975 17C9.57975 16.59 9.91975 16.25 10.3297 16.25H13.6597C14.0697 16.25 14.4097 16.59 14.4097 17C14.4097 17.41 14.0697 17.75 13.6597 17.75ZM14.4997 13.75H9.49975C9.08975 13.75 8.74975 13.41 8.74975 13C8.74975 12.59 9.08975 12.25 9.49975 12.25H14.4997C14.9097 12.25 15.2497 12.59 15.2497 13C15.2497 13.41 14.9097 13.75 14.4997 13.75Z" fill="#B60123"/>
                      </svg>
                    </button> */}
                                    </div>
                                ))}
                            </div>
                        ))
                    )}
                </div>
            </div>
        </div>
    )
}
